# LocalIPPool 本地IP池模块

## 概述

`localippool.go` 实现了一个智能的本地IP地址池管理系统，能够自动适应不同的网络环境，支持静态IPv4地址管理和动态IPv6地址生成。该模块是爬虫平台的核心组件之一，为网络请求提供IP地址轮换和管理功能。

## 核心功能

### 1. 环境自适应检测
- **IPv4地址自动检测**：当未提供静态IPv4地址时，自动检测系统中可用的IPv4地址
- **IPv6子网验证**：验证提供的IPv6子网是否在当前系统网络接口上真实可用
- **智能降级**：当IPv6环境不可用时，自动降级为仅IPv4模式

### 2. IPv6动态地址管理
- **海量地址生成**：基于IPv6子网动态生成大量IPv6地址
- **批量操作**：支持批量创建和删除IPv6地址，提高操作效率
- **地址池维护**：自动维护活跃地址池大小，与目标IP数量保持对等

### 3. 地址生命周期管理
- **地址获取**：从池中快速获取可用IP地址
- **地址释放**：支持立即删除或标记为未使用等待定期清理
- **定期清理**：每20分钟自动清理未使用的IPv6地址并替换为新地址

## 主要接口和结构体

### IPPool 接口
定义了IP地址池的标准行为契约：
```go
type IPPool interface {
    GetIP() net.IP                    // 获取IP地址
    ReleaseIP(ip net.IP)              // 释放IPv6地址
    MarkIPUnused(ip net.IP)           // 标记地址为未使用
    SetTargetIPCount(count int)       // 设置目标IP数量
    io.Closer                         // 资源清理接口
}
```

### LocalIPPool 结构体
核心实现类，包含以下关键字段：
- `staticIPv4s`：静态IPv4地址列表
- `ipv6Subnet`：IPv6子网信息
- `ipv6Queue`：预生成IPv6地址队列
- `createdIPv6Addrs`：已创建的IPv6地址映射
- `usedIPv6Addrs`：正在使用的IPv6地址映射
- `activeIPv6Addrs`：当前活跃的IPv6地址映射

## 实现方法详解

### 1. 构造函数 NewLocalIPPool
**功能**：创建并初始化智能IP池
**实现特点**：
- 环境自适应检测，验证IPv6子网可用性
- 自动检测系统IPv4地址作为后备
- 返回接口类型，强制依赖抽象而非具体实现

### 2. 核心方法 GetIP
**功能**：从池中获取可用IP地址
**实现策略**：
- IPv4模式：随机选择静态IPv4地址
- IPv6模式：从预生成队列快速获取，队列为空时即时生成
- 支持IPv4/IPv6混合模式，优先返回IPv6地址

### 3. 地址管理方法
- **ReleaseIP**：立即删除IPv6地址并创建新地址替换
- **MarkIPUnused**：标记地址为未使用，等待定期清理
- **SetTargetIPCount**：动态调整地址池大小，保持与RemoteDomainIPPool对等

### 4. 批量操作方法
- **batchCreateIPv6Addresses**：批量创建IPv6地址，提高效率
- **batchDeleteIPv6Addresses**：批量删除IPv6地址，支持系统保留地址过滤

### 5. 定期维护方法
- **cleanupUnusedIPv6Addresses**：每20分钟执行一次清理
- 清理策略：删除空闲地址并创建新地址替换，保持地址池大小

## 并发安全设计

### 锁机制
- **主锁**：`sync.RWMutex` 保护结构体字段
- **专用锁**：为不同地址映射使用独立的互斥锁
- **清理锁**：保护清理操作的时间戳

### 无锁设计
- **通道通信**：使用带缓冲的通道进行IPv6地址传递
- **原子操作**：在可能的情况下使用原子操作减少锁竞争

## 系统保留地址处理

### IPv6保留地址识别
- **::2**：常见的系统保留地址
- **其他保留地址**：通过 `isReservedIPv6Address` 函数识别
- **自动跳过**：批量操作时自动跳过保留地址

## 性能优化

### 1. 预生成队列
- 使用带缓冲的通道预生成IPv6地址
- 消费者可以快速获取地址，无需等待生成

### 2. 批量操作
- 支持批量创建和删除IPv6地址
- 减少系统调用次数，提高操作效率

### 3. 智能清理
- 定期清理未使用地址，避免地址池无限增长
- 替换策略保持地址池大小恒定

## 使用场景

### 1. 爬虫IP轮换
- 为爬虫请求提供大量不同的IP地址
- 避免被目标网站封禁

### 2. 负载均衡
- 在多个IP地址间分散请求负载
- 提高请求成功率

### 3. 地理位置模拟
- 通过不同IPv6地址模拟不同地理位置
- 绕过地域限制

## 错误处理

### 1. 优雅降级
- IPv6不可用时自动降级到IPv4模式
- 确保系统在任何环境下都能正常工作

### 2. 错误日志
- 详细的错误信息输出
- 便于问题诊断和调试

## 扩展性设计

### 1. 接口抽象
- 通过IPPool接口实现依赖注入
- 便于单元测试和功能扩展

### 2. 配置灵活
- 支持多种配置方式
- 适应不同的部署环境

## 总结

LocalIPPool模块是一个功能强大、设计精良的IP地址池管理系统。它通过环境自适应、批量操作、并发安全等设计，为爬虫平台提供了稳定可靠的IP地址管理能力。该模块的设计充分考虑了性能、可靠性和扩展性，是整个爬虫平台的重要基础设施组件。
