# TUIC协议实现说明

## 协议概述

**TUIC (The UDP Internet Connection)** 是一个**基于QUIC协议全新设计的、专门用于代理的传输协议**。它是应用层（L7）协议，完全构建在QUIC传输层之上。

### 关键理解

**TUIC协议 ≠ TUN + QUIC**

- **TUN设备**：网络层（L3）虚拟设备，用于捕获/注入IP数据包（流量收集器）
- **QUIC协议**：传输层（L4）协议，提供可靠、安全、高效的数据传输（高速公路）
- **TUIC协议**：应用层（L7）协议，专门用于代理流量的数据交换协议（专用货车）

### 正确的工作流程

```
客户端应用
    ↓ 生成网络流量（IP数据包）
TUN设备（客户端）← 捕获IP数据包
    ↓ IP数据包
TUIC客户端 ← 使用TUIC协议封装IP数据包
    ↓ TUIC协议数据（应用层）
QUIC传输层 ← 通过QUIC协议传输
    ↓ QUIC流
TUIC服务器
    ↓ 解析TUIC协议，提取IP数据包
目标网络/服务器
```

## 协议栈层次

```
应用层 (HTTP/HTTPS等)
    ↓
网络层 (IP数据包) ← TUN设备捕获
    ↓
TUIC协议层 (应用层L7) ← 专门设计的代理协议
    ↓
QUIC传输层 (传输层L4) ← 底层传输基础
    ↓
UDP传输层
```

## 当前实现

### 服务器端 (utlsProxy)

当前实现包括：

1. **QUIC连接管理**
   - 使用 `quic-go` 库建立QUIC连接
   - 支持TLS加密
   - 多路复用支持

2. **TUIC协议处理器 (IPTunnelHandler)**
   - 处理TUIC协议的CONNECT命令（建立TCP连接）
   - 处理PACKET命令（转发IP数据包或TCP数据）
   - 管理多个流的生命周期
   - 解析和封装IP数据包（支持真正的TUN模式）

3. **TCP连接转发**
   - 为每个QUIC流建立对应的TCP连接
   - 双向数据转发（QUIC ↔ TCP）

### 协议格式（TUIC V5）

#### 认证包（Authentication Packet）

客户端连接服务器时发送的第一个包：
```
[UUID (16字节)][密码 (可变长度)]
```

- **当前实现状态**：⚠️ 使用 Token 进行基本验证，待完善为标准的 UUID + 密码格式

#### CONNECT命令

```
[版本(1字节)][命令(1字节)][长度(2字节)][地址类型(1字节)][地址长度(1字节)][地址][端口(2字节)]
```

- 版本: 5 (TUIC v5) ✅
- 命令: 0 (CONNECT) ✅
- 地址类型: 0=域名, 1=IPv4, 2=IPv6 ✅

#### PACKET命令

```
[版本(1字节)][命令(1字节)][长度(2字节)][数据]
```

- 命令: 1 (PACKET) ✅
- 数据: TCP/UDP 数据或 IP 数据包 ✅
- **关联ID**：用于 UDP 会话关联 ⚠️ 部分实现

#### DISSOCIATE命令

```
[版本(1字节)][命令(1字节)][长度(2字节)][关联ID]
```

- 命令: 2 (DISSOCIATE) ❌ 未实现
- 用途: 终止一个 UDP 会话

#### 心跳包（Heartbeat）

用于保持连接活跃并测量 RTT：
```
[版本(1字节)][命令(1字节)][时间戳]
```

- ❌ 未实现

## 与标准TUIC协议的差异

### 当前实现的限制

1. **TUN设备支持**
   - 服务器端：已实现IP数据包解析和处理（IPTunnelHandler）
   - 客户端：需要配合TUN设备使用，捕获系统流量
   - 当前实现支持IP数据包隧道模式（PACKET命令）

2. **缺少的功能（按 TUIC V5 标准）**
   - ⚠️ **认证包**：当前使用 Token，待完善为标准的 UUID + 密码格式
   - ❌ **DISSOCIATE 命令**：未实现 UDP 会话终止
   - ❌ **心跳包**：未实现连接保活和 RTT 测量
   - ⚠️ **关联ID**：UDP 会话关联部分实现
   - ⚠️ **显式拥塞控制**：部分实现，待完善带宽和 RTT 信息传递

3. **简化处理**
   - 错误处理不够完善
   - 没有实现协议协商
   - 缺少详细的错误码定义

### 完整的TUIC协议实现应该包括

1. **IP数据包处理**（已部分实现）
   - ✅ 解析IP包头（IPv4/IPv6）
   - ✅ 根据协议类型（TCP/UDP）转发
   - ⚠️ 支持所有IP层协议（TCP/UDP已实现，ICMP待实现）

2. **完整的协议实现**
   - ⚠️ 遵循TUIC v5协议规范（基本实现，部分特性待完善）
   - ⚠️ 完整的Token验证（基本实现，待完善）
   - ⚠️ 协议版本协商（待实现）
   - ⚠️ 错误码定义（部分实现）

## 改进建议

### 短期改进（按 TUIC V5 标准）

1. **完善认证机制**
   - 实现标准的 UUID + 密码认证包格式
   - 在 QUIC 握手时验证认证包
   - 替换当前的 Token 验证机制

2. **实现 DISSOCIATE 命令**
   - 支持 UDP 会话终止
   - 清理关联的 UDP 连接资源

3. **实现心跳包**
   - 定期发送心跳包保持连接活跃
   - 测量 RTT 并用于拥塞控制

4. **改进错误处理**
   - 定义完整的错误码（符合 V5 标准）
   - 发送标准化的错误响应

### 长期改进

1. **完善IP数据包处理**（部分已实现）
   - ✅ 解析IP数据包（已实现）
   - ⚠️ 支持所有协议类型（TCP/UDP已实现，ICMP待实现）
   - ⚠️ 优化IP数据包处理性能

2. **协议完整性**
   - ⚠️ 完全遵循TUIC v5规范（基本实现，部分特性待完善）
   - ⚠️ 实现所有协议特性
   - ⚠️ 性能优化和拥塞控制

## TUIC V5 协议标准

### 官方资源

- **协议规范文档**： [github.com/apernet/tuic/blob/v5/protocol.md](https://github.com/apernet/tuic/blob/v5/protocol.md)
- **主仓库**： [github.com/apernet/tuic](https://github.com/apernet/tuic) （`v5` 分支）

### V5 设计哲学

TUIC V5 的核心思想是**简化与优化**：
- 移除了 V4 中复杂的动态端口机制
- 致力于提供更稳定、高效且易于实现的协议基础
- 专注于核心的 TCP 和 UDP 中继功能

### V5 主要特性

#### 1. 基于 QUIC 和 UDP

完全构建在 QUIC (基于 UDP) 之上，继承其所有优势：
- **原生加密**：使用 TLS 1.3，连接建立之初就是加密的
- **低延迟**：0-RTT 和 1-RTT 握手，快速建立连接
- **无队头阻塞**：在单个连接上并行传输多个流而不会相互阻塞
- **连接迁移**：支持在 IP 地址变化时保持连接不断

#### 2. 认证与命令包

- **认证包**：客户端连接服务器时发送的第一个包
  - 包含用于验证的 **UUID** 和 **密码**
  - 当前实现：使用 Token 进行基本验证（待完善为标准的 UUID + 密码）

- **命令包**：用于控制通信，主要类型包括：
  - `Connect` (0)：客户端发起一个新的 TCP 或 UDP 代理请求 ✅ 已实现
  - `Packet` (1)：用于传输 UDP 数据或 IP 数据包 ✅ 已实现
  - `Dissociate` (2)：终止一个 UDP 会话 ❌ 未实现

#### 3. 双模式支持

TUIC V5 明确支持两种流量模式：

- **原生模式**：客户端使用 TUN 虚拟设备捕获所有 IP 流量
  - 用于替代 VPN 场景，提供全局代理
  - 当前实现：✅ 支持 IP 数据包解析和转发

- **兼容模式**：像传统 Socks5 代理一样工作，处理 TCP 和 UDP 流量
  - 客户端软件（如 Clash Meta）常用的模式
  - 当前实现：✅ 支持 CONNECT 命令（TCP 代理）

#### 4. 精简的传输机制

- **去除动态端口**：V4 中复杂的动态端口协商被移除 ✅ 已实现
- **显式拥塞控制**：协议层面支持传递带宽和 RTT 等网络信息 ⚠️ 部分实现
- **心跳包**：通过定期发送心跳包来保持连接活跃，并用于测量 RTT ❌ 未实现

#### 5. 数据包结构

数据包结构设计得非常紧凑，以减少开销：
- **包头**：包含版本、命令类型等基本信息 ✅ 已实现
- **数据段**：携带实际的代理负载（TCP 流或 UDP 数据报） ✅ 已实现
- **关联ID**：用于将多个 UDP `Packet` 关联到同一个会话 ⚠️ 部分实现

### 与 V4 的主要区别

| 特性 | TUIC V4 | TUIC V5 | 当前实现状态 |
| :--- | :--- | :--- | :--- |
| **认证** | UUID + 密码 | UUID + 密码（更简化） | ⚠️ 使用 Token（待完善为 UUID + 密码） |
| **UDP 中继** | 使用复杂的**动态端口** | 使用简化的 **`Associate ID`** | ⚠️ 部分实现 |
| **协议复杂性** | 相对复杂，功能多 | **极大简化**，核心稳定 | ✅ 已简化实现 |
| **设计目标** | 功能丰富 | **高性能与稳定性** | ✅ 专注于核心功能 |

## 参考资源

### 官方规范
- [TUIC V5 协议规范](https://github.com/apernet/tuic/blob/v5/protocol.md) - **官方 V5 规范文档**
- [TUIC 主仓库](https://github.com/apernet/tuic) - V5 分支
- [QUIC协议规范](https://www.rfc-editor.org/rfc/rfc9000.html)

### 优秀实现参考
- **[sing-box](https://github.com/SagerNet/sing-box)** - 通用代理平台，TUIC 协议实现非常完善 ⭐ **强烈推荐学习**
  - 生产级实现，被大量用户使用和验证（28.4k+ stars）
  - 支持完整的 TUIC V5 协议规范
  - 代码质量高，架构设计优秀
  - 文档：https://sing-box.sagernet.org
  - 重点关注：`protocol/tuic/` 和 `transport/tuic/` 目录
- [TUIC-Server (Go)](https://github.com/apernet/tuic-go) - 官方 Go 实现
- [Clash Meta](https://github.com/MetaCubeX/mihomo) - 支持 TUIC V5 的客户端

**详细参考说明**：请查看 [SING_BOX_TUIC_REFERENCE.md](SING_BOX_TUIC_REFERENCE.md)

## 当前状态

✅ **已实现**:
- QUIC连接管理
- 基本的CONNECT和PACKET命令处理
- TCP连接转发
- 多流支持

⚠️ **待改进**:
- Token验证机制
- 错误处理完善
- 协议规范完整性
- 性能优化

⚠️ **部分实现/待完善**:
- ICMP协议支持
- 标准的 UUID + 密码认证包（当前使用 Token）
- DISSOCIATE 命令（UDP 会话终止）
- 心跳包（连接保活和 RTT 测量）
- 关联ID 完整实现（UDP 会话关联）
- 显式拥塞控制（带宽和 RTT 信息传递）

❌ **未实现**:
- DISSOCIATE 命令
- 心跳包机制
