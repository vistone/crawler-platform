# TUIC V5 协议标准实现指南

## 官方资源

- **协议规范文档**： [github.com/apernet/tuic/blob/v5/protocol.md](https://github.com/apernet/tuic/blob/v5/protocol.md)
- **主仓库**： [github.com/apernet/tuic](https://github.com/apernet/tuic) （`v5` 分支）

## TUIC V5 设计哲学

V5 版本的核心思想是**简化与优化**：
- 移除了 V4 及之前版本中一些复杂和冗余的部分（如动态端口机制）
- 致力于提供一个更稳定、高效且易于实现的协议基础
- 专注于核心的 TCP 和 UDP 中继功能

## 主要协议标准与特性

### 1. 基于 QUIC 和 UDP

TUIC V5 完全构建在 **QUIC (基于 UDP)** 之上，继承了其所有优势：

- **原生加密**：使用 TLS 1.3，连接建立之初就是加密的
- **低延迟**：0-RTT 和 1-RTT 握手，快速建立连接
- **无队头阻塞**：在单个连接上并行传输多个流而不会相互阻塞
- **连接迁移**：支持在 IP 地址变化时保持连接不断

### 2. 认证与命令包

#### 认证包（Authentication Packet）

客户端连接服务器时发送的第一个包。包含了用于验证的 **UUID** 和 **密码**。

**格式**：
```
[UUID (16字节)][密码 (可变长度)]
```

**当前实现状态**：⚠️ 使用 Token 进行基本验证，待完善为标准的 UUID + 密码格式

#### 命令包类型

- **Connect (0)**：客户端发起一个新的 TCP 或 UDP 代理请求
  - ✅ 已实现
  
- **Packet (1)**：用于传输 UDP 数据或 IP 数据包
  - ✅ 已实现
  
- **Dissociate (2)**：终止一个 UDP 会话
  - ❌ 未实现

### 3. 双模式支持

TUIC V5 明确支持两种流量模式：

#### 原生模式（Native Mode）

客户端使用 TUN 虚拟设备捕获所有 IP 流量。这是为了替代 VPN 场景，提供全局代理。

**当前实现状态**：✅ 支持 IP 数据包解析和转发

#### 兼容模式（Compatibility Mode）

像传统 Socks5 代理一样工作，处理 TCP 和 UDP 流量。这是客户端软件（如 Clash Meta）常用的模式。

**当前实现状态**：✅ 支持 CONNECT 命令（TCP 代理）

### 4. 精简的传输机制

- **去除动态端口**：V4 中复杂的动态端口协商被移除
  - ✅ 已实现
  
- **显式拥塞控制**：协议层面支持传递带宽和 RTT 等网络信息，允许实现更智能的拥塞控制算法（如 BBR）
  - ⚠️ 部分实现
  
- **心跳包**：通过定期发送心跳包来保持连接活跃，并用于测量 RTT
  - ❌ 未实现

### 5. 数据包结构

数据包结构设计得非常紧凑，以减少开销：

- **包头**：包含版本、命令类型等基本信息 ✅ 已实现
- **数据段**：携带实际的代理负载（TCP 流或 UDP 数据报） ✅ 已实现
- **关联ID**：用于将多个 UDP `Packet` 关联到同一个会话 ⚠️ 部分实现

## 与 V4 的主要区别

| 特性 | TUIC V4 | TUIC V5 | 当前实现状态 |
| :--- | :--- | :--- | :--- |
| **认证** | UUID + 密码 | UUID + 密码（更简化） | ⚠️ 使用 Token（待完善为 UUID + 密码） |
| **UDP 中继** | 使用复杂的**动态端口** | 使用简化的 **`Associate ID`** | ⚠️ 部分实现 |
| **协议复杂性** | 相对复杂，功能多 | **极大简化**，核心稳定 | ✅ 已简化实现 |
| **设计目标** | 功能丰富 | **高性能与稳定性** | ✅ 专注于核心功能 |

## 当前实现状态总结

### ✅ 已实现

- QUIC 传输层（L4）：完全实现，支持 TLS 1.3、多流、0-RTT 等
- TUIC 协议层（L7）：基本实现
  - ✅ CONNECT 命令（TCP 代理模式）
  - ✅ PACKET 命令（IP 数据包隧道模式）
- IP 数据包处理（L3）：
  - ✅ IPv4/IPv6 数据包解析
  - ✅ TCP 连接管理和状态机
  - ✅ UDP 数据包转发
  - ✅ IP 数据包封装和回传

### ⚠️ 部分实现/待完善

- **认证机制**：当前使用 Token，待完善为标准的 UUID + 密码格式
- **关联ID**：UDP 会话关联部分实现
- **显式拥塞控制**：部分实现，待完善带宽和 RTT 信息传递
- **ICMP 协议支持**：待实现

### ❌ 未实现

- **DISSOCIATE 命令**：UDP 会话终止
- **心跳包机制**：连接保活和 RTT 测量

## 实现优先级

### 高优先级（核心功能）

1. **完善认证机制**：实现标准的 UUID + 密码认证包格式
2. **实现 DISSOCIATE 命令**：支持 UDP 会话终止
3. **实现心跳包**：连接保活和 RTT 测量

### 中优先级（性能优化）

1. **完善关联ID**：完整实现 UDP 会话关联
2. **显式拥塞控制**：完善带宽和 RTT 信息传递
3. **ICMP 协议支持**：扩展协议支持范围

### 低优先级（增强功能）

1. **性能监控**：连接统计和性能指标
2. **配置热重载**：运行时配置更新
3. **高级路由功能**：基于规则的流量路由

## 参考实现

- [TUIC-Server (Go)](https://github.com/apernet/tuic-go) - 官方 Go 实现
- [Clash Meta](https://github.com/MetaCubeX/mihomo) - 支持 TUIC V5 的客户端

## 兼容性说明

**重要**：在配置时，请务必确保客户端和服务端的版本兼容（都使用 V5）。

主流支持 TUIC 的客户端（如 **Clash Meta**）和服务端（如 **TUIC-Server**）都已优先支持并推荐使用 V5 版本。

