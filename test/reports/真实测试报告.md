# 真实测试报告 - utlsProxy + utlsclient 高并发测试

## 测试时间
2025-11-29 00:30

## 测试环境
- 操作系统: Linux
- 工作目录: /home/stone/crawler-platform
- Go版本: 待确认

## 发现的问题

### 问题1: concurrent-test flag未定义
**现象**: 
```
flag provided but not defined: -concurrent-test
```

**原因**: flag定义在flag.Parse()之后

**修复**: 已将concurrentTest flag移到flag.Parse()之前定义

### 问题2: QUIC连接失败
**现象**: 
```
连接服务器失败: 建立QUIC连接失败: write udp 127.0.0.1:51941->127.0.0.1:18443: use of WriteTo with pre-connected connection
```

**原因**: 使用`net.DialUDP`创建预连接的UDP连接，然后传给`quic.Dial`会导致错误

**修复**: 改为使用`net.ListenUDP("udp", nil)`创建未绑定的UDP连接，让quic.Dial自己管理连接

### 问题3: 客户端响应解析错误
**现象**: 客户端无法正确解析服务器返回的TUIC PACKET格式响应

**修复**: 
- 先读取CONNECT响应（4字节）
- 然后循环读取PACKET命令，累积HTTP响应数据
- 最后解析完整的HTTP响应

## 修复后的代码变更

### cmd/utlsclient/main.go
- 将`concurrentTest` flag定义移到`flag.Parse()`之前

### cmd/utlsclient/tuic_client.go
- 修复QUIC连接创建方式（使用ListenUDP而不是DialUDP）
- 修复响应解析逻辑（先读CONNECT响应，再读PACKET数据）

## 待重新测试

修复完成后，需要重新运行测试验证：
```bash
./run_real_test.sh
```

## 测试结果

**当前状态**: 已修复编译和连接问题，等待重新运行完整测试

**下一步**: 
1. 重新运行测试脚本
2. 记录真实的测试结果
3. 如果仍有问题，继续修复
