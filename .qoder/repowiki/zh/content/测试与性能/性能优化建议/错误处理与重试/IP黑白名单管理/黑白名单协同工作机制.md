# 黑白名单协同工作机制

<cite>
**本文档引用的文件**
- [ip_access_controller.go](file://utlsclient/ip_access_controller.go)
- [health_checker.go](file://utlsclient/health_checker.go)
- [utlshotconnpool.go](file://utlsclient/utlshotconnpool.go)
- [connection_manager.go](file://utlsclient/connection_manager.go)
- [interfaces.go](file://utlsclient/interfaces.go)
- [connection_validator.go](file://utlsclient/connection_validator.go)
- [ip_access_controller_test.go](file://test/utlsclient/ip_access_controller_test.go)
</cite>

## 目录
1. [概述](#概述)
2. [系统架构](#系统架构)
3. [核心组件分析](#核心组件分析)
4. [协同工作机制](#协同工作机制)
5. [监控与统计](#监控与统计)
6. [调用链路示例](#调用链路示例)
7. [故障隔离与流量调度](#故障隔离与流量调度)
8. [总结](#总结)

## 概述

在UTLS热连接池系统中，IPAccessController与HealthChecker通过紧密协作实现了自动化的故障隔离与流量调度机制。当HealthChecker检测到连接频繁失败时，会触发IPAccessController将问题IP加入黑名单；同时，UTLSHotConnPool在获取连接前通过IsIPAllowed方法检查IP访问权限，从而实现智能的流量分发和故障转移。

## 系统架构

```mermaid
graph TB
subgraph "连接池管理层"
UTHCP[UTLSHotConnPool]
CM[ConnectionManager]
HC[HealthChecker]
AC[IPAccessController]
end
subgraph "连接层"
Conn1[连接1]
Conn2[连接2]
ConnN[连接N]
end
subgraph "监控层"
Stats[统计信息]
BlockedIPs[黑名单IP]
AllowedIPs[白名单IP]
end
UTHCP --> CM
UTHCP --> HC
UTHCP --> AC
HC --> Conn1
HC --> Conn2
HC --> ConnN
AC --> BlockedIPs
AC --> AllowedIPs
UTHCP --> Stats
```

**图表来源**
- [utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L236-L258)
- [connection_manager.go](file://utlsclient/connection_manager.go#L8-L14)
- [health_checker.go](file://utlsclient/health_checker.go#L9-L13)
- [ip_access_controller.go](file://utlsclient/ip_access_controller.go#L7-L12)

## 核心组件分析

### IPAccessController - IP访问控制器

IPAccessController负责维护IP白名单和黑名单，提供访问控制功能：

```mermaid
classDiagram
class IPAccessController {
+map[string]bool whitelist
+map[string]bool blacklist
+sync.RWMutex mu
+NewIPAccessController() IPAccessController
+IsIPAllowed(ip string) bool
+AddIP(ip string, isWhite bool)
+GetAllowedIPs() []string
+GetBlockedIPs() []string
+RemoveFromBlacklist(ip string)
+AddToWhitelist(ip string)
+RemoveFromWhitelist(ip string)
+ClearWhitelist()
+ClearBlacklist()
+GetStats() (int, int)
+Contains(ip string, isWhite bool) bool
+Size(isWhite bool) int
+IsEmpty(isWhite bool) bool
}
class AccessController {
<<interface>>
+IsIPAllowed(ip string) bool
+AddIP(ip string, isWhite bool)
+GetAllowedIPs() []string
+GetBlockedIPs() []string
+RemoveFromBlacklist(ip string)
+AddToWhitelist(ip string)
}
IPAccessController ..|> AccessController
```

**图表来源**
- [ip_access_controller.go](file://utlsclient/ip_access_controller.go#L7-L12)
- [interfaces.go](file://utlsclient/interfaces.go#L22-L49)

### HealthChecker - 健康检查器

HealthChecker负责监控连接健康状态，检测连接失败情况：

```mermaid
classDiagram
class HealthChecker {
+ConnectionManager connManager
+PoolConfig config
+NewHealthChecker(connManager, config) HealthChecker
+CheckConnection(conn *UTLSConnection) bool
+performHealthCheck(conn *UTLSConnection) error
+CheckAllConnections()
+GetHealthyConnections() []*UTLSConnection
+GetUnhealthyConnections() []*UTLSConnection
+CleanupUnhealthyConnections() int
}
class UTLSConnection {
+bool healthy
+int64 errorCount
+time.Time lastUsed
+string targetIP
+string targetHost
+sync.Mutex mu
}
HealthChecker --> UTLSConnection : "检查"
HealthChecker --> ConnectionManager : "使用"
```

**图表来源**
- [health_checker.go](file://utlsclient/health_checker.go#L9-L13)
- [connection_manager.go](file://utlsclient/connection_manager.go#L8-L14)

**章节来源**
- [ip_access_controller.go](file://utlsclient/ip_access_controller.go#L1-L184)
- [health_checker.go](file://utlsclient/health_checker.go#L1-L165)

## 协同工作机制

### 健康检查与黑名单联动

HealthChecker通过以下机制检测连接失败并触发黑名单添加：

```mermaid
sequenceDiagram
participant HC as HealthChecker
participant Conn as UTLSConnection
participant AC as IPAccessController
participant CM as ConnectionManager
HC->>Conn : CheckConnection()
Conn-->>HC : errorCount > maxErrorCount
HC->>Conn : 设置healthy = false
HC->>CM : RemoveConnection(ip)
CM->>AC : AddIP(ip, false) // 添加到黑名单
AC-->>CM : IP已添加到黑名单
CM-->>HC : 连接已移除
```

**图表来源**
- [health_checker.go](file://utlsclient/health_checker.go#L36-L44)
- [utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L774-L776)

### 连接获取时的访问控制

UTLSHotConnPool在获取连接时通过IP访问控制确保流量正确路由：

```mermaid
sequenceDiagram
participant Pool as UTLSHotConnPool
participant AC as IPAccessController
participant CM as ConnectionManager
participant Conn as UTLSConnection
Pool->>AC : IsIPAllowed(ip)
AC-->>Pool : false (在黑名单中)
Pool->>Pool : 尝试下一个IP
Pool->>AC : IsIPAllowed(nextIp)
AC-->>Pool : true (允许访问)
Pool->>CM : GetConnection(ip)
CM-->>Pool : 返回连接
Pool->>Conn : 验证连接有效性
Conn-->>Pool : 连接可用
```

**图表来源**
- [utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L432-L445)
- [ip_access_controller.go](file://utlsclient/ip_access_controller.go#L22-L41)

**章节来源**
- [health_checker.go](file://utlsclient/health_checker.go#L24-L61)
- [utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L432-L445)

## 监控与统计

系统提供了完整的监控接口来跟踪黑白名单状态变化：

### 统计信息接口

| 方法 | 功能 | 返回值 |
|------|------|--------|
| `GetStats()` | 获取黑白名单统计信息 | 白名单数量, 黑名单数量 |
| `GetAllowedIPs()` | 获取白名单IP列表 | 白名单IP数组 |
| `GetBlockedIPs()` | 获取黑名单IP列表 | 黑名单IP数组 |
| `Contains(ip, isWhite)` | 检查IP是否在指定列表 | 布尔值 |
| `Size(isWhite)` | 获取指定列表大小 | 整数值 |
| `IsEmpty(isWhite)` | 检查指定列表是否为空 | 布尔值 |

### 实时监控流程

```mermaid
flowchart TD
Start([监控启动]) --> CheckInterval{检查间隔}
CheckInterval --> |定时触发| GetStats[获取统计信息]
GetStats --> LogStats[记录统计数据]
LogStats --> CheckInterval
CheckInterval --> CheckHealth{健康检查}
CheckHealth --> |发现失败| AddToBlacklist[添加到黑名单]
AddToBlacklist --> UpdateStats[更新统计]
UpdateStats --> CheckInterval
CheckHealth --> |连接正常| Continue[继续监控]
Continue --> CheckInterval
```

**图表来源**
- [ip_access_controller.go](file://utlsclient/ip_access_controller.go#L141-L161)
- [health_checker.go](file://utlsclient/health_checker.go#L91-L112)

**章节来源**
- [ip_access_controller.go](file://utlsclient/ip_access_controller.go#L141-L184)
- [health_checker.go](file://utlsclient/health_checker.go#L91-L165)

## 调用链路示例

### 完整的故障处理链路

以下是一个完整的调用链路示例，展示从连接错误累积到黑名单添加的全过程：

```mermaid
sequenceDiagram
participant Client as 客户端请求
participant Pool as UTLSHotConnPool
participant AC as IPAccessController
participant HC as HealthChecker
participant Conn as UTLSConnection
participant Validator as ConnectionValidator
Client->>Pool : GetConnection(host)
Pool->>AC : IsIPAllowed(ip)
AC-->>Pool : true (IP允许)
Pool->>Pool : createNewHotConnection()
Pool->>Conn : establishConnection()
Conn->>Conn : TLS握手失败
Conn-->>Pool : 连接建立失败
Pool->>Pool : 增加errorCount
Pool->>Pool : 尝试重试连接
Pool->>Conn : 增加errorCount
Pool->>HC : CheckConnection(conn)
HC->>Conn : 检查errorCount > 10
HC->>Conn : 设置healthy = false
HC->>Pool : 连接不健康
Pool->>Pool : removeFromPool(conn)
Pool->>AC : AddIP(ip, false)
AC->>AC : 添加到黑名单
AC-->>Pool : IP已加入黑名单
Pool-->>Client : 连接失败，尝试下一个IP
```

**图表来源**
- [utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L530-L553)
- [health_checker.go](file://utlsclient/health_checker.go#L36-L44)
- [ip_access_controller.go](file://utlsclient/ip_access_controller.go#L44-L60)

### 连接验证失败处理

当连接验证失败时，系统会执行以下处理流程：

```mermaid
flowchart TD
Start([连接验证开始]) --> SendRequest[发送HEAD请求]
SendRequest --> CheckResponse{检查响应}
CheckResponse --> |状态码403| Forbidden[IP被封禁]
CheckResponse --> |状态码200| Success[验证成功]
CheckResponse --> |其他错误| Failure[验证失败]
Forbidden --> MarkUnhealthy[标记连接不健康]
Failure --> MarkUnhealthy
MarkUnhealthy --> IncreaseErrorCount[增加错误计数]
IncreaseErrorCount --> CheckErrorThreshold{错误次数 > 10?}
CheckErrorThreshold --> |是| AddToBlacklist[添加到黑名单]
CheckErrorThreshold --> |否| KeepConnection[保持连接]
AddToBlacklist --> RemoveConnection[移除连接]
Success --> UpdateStats[更新统计]
KeepConnection --> UpdateStats
RemoveConnection --> End([处理完成])
UpdateStats --> End
```

**图表来源**
- [connection_validator.go](file://utlsclient/connection_validator.go#L41-L96)
- [health_checker.go](file://utlsclient/health_checker.go#L36-L44)

**章节来源**
- [utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L530-L553)
- [connection_validator.go](file://utlsclient/connection_validator.go#L41-L96)

## 故障隔离与流量调度

### 自动化故障隔离机制

系统通过多层次的防护机制实现自动化故障隔离：

1. **连接级别隔离**：单个连接失败时，仅移除该连接而不影响其他连接
2. **IP级别隔离**：连续失败达到阈值时，将整个IP加入黑名单
3. **域名级别隔离**：同一域名下的所有IP都受影响，防止集中式攻击
4. **动态恢复**：支持手动或自动从黑名单移除IP

### 流量调度策略

```mermaid
graph LR
subgraph "流量入口"
Request[客户端请求]
end
subgraph "访问控制层"
ACL[IPAccessController<br/>检查IP权限]
end
subgraph "连接池层"
CP[ConnectionPool<br/>管理连接]
HC[HealthChecker<br/>健康检查]
end
subgraph "目标服务器"
Server1[服务器1]
Server2[服务器2]
Server3[服务器3]
end
Request --> ACL
ACL --> |允许| CP
ACL --> |拒绝| Blocked[拒绝访问]
CP --> HC
HC --> |健康| Server1
HC --> |健康| Server2
HC --> |健康| Server3
HC --> |不健康| Retry[重试其他IP]
Retry --> CP
```

**图表来源**
- [utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L432-L445)
- [ip_access_controller.go](file://utlsclient/ip_access_controller.go#L22-L41)

### 配置参数优化

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `maxErrorCount` | 10 | 连接失败阈值，超过此值将IP加入黑名单 |
| `healthCheckInterval` | 30秒 | 健康检查间隔时间 |
| `blacklistCheckInterval` | 5分钟 | 黑名单检查间隔时间 |
| `maxConnections` | 100 | 最大连接数限制 |
| `maxConnsPerHost` | 10 | 每个主机最大连接数 |

**章节来源**
- [health_checker.go](file://utlsclient/health_checker.go#L36-L44)
- [utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L186-L201)

## 总结

IPAccessController与HealthChecker的协同工作机制构成了UTLS热连接池系统的核心防护体系。通过健康检查检测连接失败，通过IP访问控制实现故障隔离，系统能够自动识别和处理网络异常，确保服务的稳定性和可靠性。

这种设计的优势包括：

1. **自动化程度高**：无需人工干预即可自动识别和处理故障
2. **响应速度快**：通过实时监控和快速决策机制，迅速隔离问题IP
3. **可扩展性强**：支持动态调整配置参数，适应不同的业务需求
4. **监控完善**：提供丰富的监控接口，便于运维人员掌握系统状态

通过这种协同工作机制，系统能够在保证服务质量的同时，有效抵御各种网络威胁和异常情况，为上层应用提供稳定可靠的连接服务。