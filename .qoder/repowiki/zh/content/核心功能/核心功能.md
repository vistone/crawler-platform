# æ ¸å¿ƒåŠŸèƒ½

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [README.md](file://README.md)
- [utlsclient/utlshotconnpool.go](file://utlsclient/utlshotconnpool.go)
- [utlsclient/utlsfingerprint.go](file://utlsclient/utlsfingerprint.go)
- [localippool/localippool.go](file://localippool/localippool.go)
- [remotedomainippool/remotedomainippool.go](file://remotedomainippool/remotedomainippool.go)
- [utlsclient/utlsclient.go](file://utlsclient/utlsclient.go)
- [utlsclient/connection_manager.go](file://utlsclient/connection_manager.go)
- [utlsclient/health_checker.go](file://utlsclient/health_checker.go)
- [examples/utlsclient/example_hotconnpool_usage.go](file://examples/utlsclient/example_hotconnpool_usage.go)
- [examples/utlsclient/example_utlsclient_usage.go](file://examples/utlsclient/example_utlsclient_usage.go)
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go) - *æ–°å¢ Google Earth Q2 è§£æå™¨*
- [Store/tilestorage.go](file://Store/tilestorage.go) - *æ–°å¢å¤šåç«¯å­˜å‚¨æ¶æ„*
- [Store/bblotdb.go](file://Store/bblotdb.go) - *BBolt æŒä¹…åŒ–å®ç°*
- [Store/sqlitedb.go](file://Store/sqlitedb.go) - *SQLite æŒä¹…åŒ–å®ç°*
- [Store/dbpath.go](file://Store/dbpath.go) - *æ•°æ®åº“è·¯å¾„ç®¡ç†*
</cite>

## æ›´æ–°æ‘˜è¦
**å˜æ›´å†…å®¹**   
- æ–°å¢ **Google Earth Q2 è§£æå™¨** åŠŸèƒ½æ¨¡å—ï¼Œæ”¯æŒè§£æ Google Earth Q2 æ•°æ®åŒ…
- æ–°å¢ **å¤šåç«¯å­˜å‚¨æ¶æ„** åŠŸèƒ½æ¨¡å—ï¼Œæ”¯æŒ BBolt å’Œ SQLite æŒä¹…åŒ–åç«¯
- æ›´æ–° **é¡¹ç›®æ¶æ„æ¦‚è§ˆ** å›¾è¡¨ï¼ŒåŒ…å«æ–°å¢ç»„ä»¶
- æ–°å¢ **Google Earth Q2 è§£æå™¨** å’Œ **å¤šåç«¯å­˜å‚¨æ¶æ„** ä¸¤ä¸ªæ–°ç« èŠ‚
- æ›´æ–° **åŠŸèƒ½ä¾èµ–å…³ç³»åˆ†æ** å›¾è¡¨ï¼Œåæ˜ æ–°å¢ä¾èµ–
- å¢å¼ºæºç è¿½è¸ªç³»ç»Ÿï¼Œæ·»åŠ æ–°åŠŸèƒ½ç›¸å…³æ–‡ä»¶å¼•ç”¨

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®æ¶æ„æ¦‚è§ˆ](#é¡¹ç›®æ¶æ„æ¦‚è§ˆ)
3. [çƒ­è¿æ¥æ± æ ¸å¿ƒåŠŸèƒ½](#çƒ­è¿æ¥æ± æ ¸å¿ƒåŠŸèƒ½)
4. [TLSæŒ‡çº¹ä¼ªè£…æŠ€æœ¯](#tlsæŒ‡çº¹ä¼ªè£…æŠ€æœ¯)
5. [IPæ± ç®¡ç†æœºåˆ¶](#ipæ± ç®¡ç†æœºåˆ¶)
6. [HTTPåè®®æ”¯æŒ](#httpåè®®æ”¯æŒ)
7. [Google Earth Q2è§£æå™¨](#google-earth-q2è§£æå™¨)
8. [å¤šåç«¯å­˜å‚¨æ¶æ„](#å¤šåç«¯å­˜å‚¨æ¶æ„)
9. [åŠŸèƒ½ä¾èµ–å…³ç³»åˆ†æ](#åŠŸèƒ½ä¾èµ–å…³ç³»åˆ†æ)
10. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
11. [æœ€ä½³å®è·µæŒ‡å—](#æœ€ä½³å®è·µæŒ‡å—)
12. [æ€»ç»“](#æ€»ç»“)

## ç®€ä»‹

Crawler Platform æ˜¯ä¸€ä¸ªåŸºäº uTLS çš„é«˜æ€§èƒ½çˆ¬è™«å¹³å°ï¼Œä¸“é—¨è®¾è®¡ç”¨äºç»•è¿‡ç°ä»£ Web åº”ç”¨çš„å®‰å…¨æ£€æµ‹æœºåˆ¶ã€‚è¯¥é¡¹ç›®é€šè¿‡åˆ›æ–°çš„æŠ€æœ¯ç»„åˆï¼Œå®ç°äº†çªç ´æ€§çš„æ€§èƒ½æå‡å’Œé«˜åº¦çš„éšè”½æ€§ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **ğŸ”¥ çƒ­è¿æ¥æ± **: é¢„å»ºç«‹ TLS è¿æ¥å¹¶å¤ç”¨ï¼Œæ€§èƒ½æå‡ 3-6 å€
- **ğŸ­ TLS æŒ‡çº¹ä¼ªè£…**: æ”¯æŒ 33 ç§çœŸå®æµè§ˆå™¨æŒ‡çº¹ï¼Œæ¨¡æ‹Ÿ Chromeã€Firefoxã€Safariã€Edge ç­‰
- **ğŸŒ å¤šè¯­è¨€æ”¯æŒ**: éšæœºç”Ÿæˆ Accept-Language å¤´ï¼Œä» 90 ç§è¯­è¨€ä¸­ç»„åˆï¼Œ97.8% ç‹¬ç‰¹æ€§
- **ğŸ“¡ åŒåè®®æ”¯æŒ**: è‡ªåŠ¨æ£€æµ‹ HTTP/1.1 å’Œ HTTP/2ï¼Œå®Œç¾æ”¯æŒ h2 è¿æ¥å¤ç”¨
- **ğŸŒ åŒæ ˆç½‘ç»œ**: å®Œæ•´æ”¯æŒ IPv4 å’Œ IPv6 åœ°å€
- **ğŸ”’ å®‰å…¨å¯é **: æ­»é”é¢„é˜²ã€è¿æ¥å¥åº·æ£€æŸ¥ã€è‡ªåŠ¨é‡è¯•æœºåˆ¶
- **ğŸ›°ï¸ Google Earth Q2 è§£æ**: æ–°å¢æ”¯æŒè§£æ Google Earth Q2 æ•°æ®åŒ…ï¼Œæå–å½±åƒã€åœ°å½¢ã€çŸ¢é‡ç­‰å¼•ç”¨ä¿¡æ¯
- **ğŸ’¾ å¤šåç«¯å­˜å‚¨**: æ–°å¢å¤šåç«¯å­˜å‚¨æ¶æ„ï¼Œæ”¯æŒ BBolt å’Œ SQLite æŒä¹…åŒ–ï¼Œå¯é€‰ Redis ç¼“å­˜å’Œå¼‚æ­¥æŒä¹…åŒ–

## é¡¹ç›®æ¶æ„æ¦‚è§ˆ

```mermaid
graph TB
subgraph "ç”¨æˆ·æ¥å£å±‚"
CLI[å‘½ä»¤è¡Œå·¥å…·]
API[HTTP API]
end
subgraph "æ ¸å¿ƒæœåŠ¡å±‚"
HC[çƒ­è¿æ¥æ± <br/>UTLSHotConnPool]
FP[TLSæŒ‡çº¹åº“<br/>Library]
IP[IPæ± ç®¡ç†<br/>IPPoolProvider]
AC[è®¿é—®æ§åˆ¶å™¨<br/>IPAccessController]
Q2[Q2è§£æå™¨<br/>Q2Parser]
ST[å­˜å‚¨ç®¡ç†å™¨<br/>TileStorage]
end
subgraph "è¿æ¥ç®¡ç†å±‚"
CM[è¿æ¥ç®¡ç†å™¨<br/>ConnectionManager]
HC_CHECK[å¥åº·æ£€æŸ¥å™¨<br/>HealthChecker]
CV[è¿æ¥éªŒè¯å™¨<br/>ConnectionValidator]
end
subgraph "ä¼ è¾“å±‚"
TC[UTLSå®¢æˆ·ç«¯<br/>UTLSClient]
HTTP1[HTTP/1.1å¤„ç†å™¨]
HTTP2[HTTP/2å¤„ç†å™¨]
end
subgraph "ç½‘ç»œå±‚"
IPv4[IPv4åœ°å€æ± ]
IPv6[IPv6åœ°å€æ± ]
DNS[DNSè§£æå™¨]
end
subgraph "æ•°æ®å±‚"
BB[BBoltæŒä¹…åŒ–]
SQ[SQLiteæŒä¹…åŒ–]
RD[Redisç¼“å­˜]
end
CLI --> HC
API --> HC
HC --> CM
HC --> FP
HC --> IP
HC --> AC
HC --> TC
CM --> HC_CHECK
CM --> CV
TC --> HTTP1
TC --> HTTP2
IP --> IPv4
IP --> IPv6
IP --> DNS
HC --> Q2
HC --> ST
ST --> BB
ST --> SQ
ST --> RD
```

**å›¾è¡¨æ¥æº**
- [utlsclient/utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L236-L258)
- [utlsclient/connection_manager.go](file://utlsclient/connection_manager.go#L8-L14)
- [localippool/localippool.go](file://localippool/localippool.go#L32-L69)
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go#L19-L24)
- [Store/tilestorage.go](file://Store/tilestorage.go#L43-L45)

## çƒ­è¿æ¥æ± æ ¸å¿ƒåŠŸèƒ½

### è®¾è®¡ç†å¿µ

çƒ­è¿æ¥æ± æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡é¢„å»ºç«‹å’Œå¤ç”¨ TLS è¿æ¥æ¥æ˜¾è‘—æå‡æ€§èƒ½ã€‚å…¶è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **é¢„çƒ­æœºåˆ¶**: åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶é¢„å…ˆå»ºç«‹å¤§é‡è¿æ¥
2. **æ™ºèƒ½å¤ç”¨**: æ ¹æ®è´Ÿè½½åŠ¨æ€åˆ†é…å¯ç”¨è¿æ¥
3. **å¥åº·ç›‘æ§**: æŒç»­ç›‘æ§è¿æ¥çŠ¶æ€ï¼ŒåŠæ—¶å‰”é™¤æ•…éšœè¿æ¥
4. **å¹¶å‘å®‰å…¨**: ä½¿ç”¨å¤šçº§é”æœºåˆ¶ç¡®ä¿é«˜å¹¶å‘ä¸‹çš„å®‰å…¨æ€§

### æ ¸å¿ƒæ¶æ„

```mermaid
classDiagram
class UTLSHotConnPool {
+connManager : ConnectionManager
+healthChecker : HealthChecker
+validator : ConnectionValidator
+ipAccessCtrl : IPAccessController
+config : PoolConfig
+stats : PoolStats
+GetConnection(targetHost) UTLSConnection
+PutConnection(conn) void
+GetStats() PoolStats
+IsHealthy() bool
+Close() error
}
class ConnectionManager {
+connections : map[string]*UTLSConnection
+hostMapping : map[string][]string
+config : PoolConfig
+AddConnection(conn) void
+RemoveConnection(ip) void
+GetConnectionsForHost(host) []*UTLSConnection
+CleanupIdleConnections() int
}
class UTLSConnection {
+conn : net.Conn
+tlsConn : *utls.UConn
+targetIP : string
+targetHost : string
+fingerprint : Profile
+acceptLanguage : string
+h2ClientConn : interface{}
+inUse : bool
+healthy : bool
+requestCount : int64
+errorCount : int64
+mu : sync.Mutex
+cond : sync.Cond
}
UTLSHotConnPool --> ConnectionManager
UTLSHotConnPool --> UTLSConnection
ConnectionManager --> UTLSConnection
```

**å›¾è¡¨æ¥æº**
- [utlsclient/utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L236-L258)
- [utlsclient/connection_manager.go](file://utlsclient/connection_manager.go#L8-L14)
- [utlsclient/utlsclient.go](file://utlsclient/utlsclient.go#L37-L52)

### å·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯
participant Pool as çƒ­è¿æ¥æ± 
participant Manager as è¿æ¥ç®¡ç†å™¨
participant Validator as è¿æ¥éªŒè¯å™¨
participant IP as IPæ± 
participant Target as ç›®æ ‡æœåŠ¡å™¨
Client->>Pool : GetConnection(host)
Pool->>Manager : GetConnectionsForHost(host)
Manager-->>Pool : å¯ç”¨è¿æ¥åˆ—è¡¨
alt æ‰¾åˆ°å¯ç”¨è¿æ¥
Pool->>Pool : æ£€æŸ¥è¿æ¥å¥åº·çŠ¶æ€
Pool-->>Client : è¿”å›å¥åº·è¿æ¥
else æ— å¯ç”¨è¿æ¥
Pool->>IP : è·å–æ–°IP
IP-->>Pool : åˆ†é…IPåœ°å€
Pool->>Pool : åˆ›å»ºæ–°è¿æ¥
Pool->>Validator : éªŒè¯è¿æ¥å¯ç”¨æ€§
Validator->>Target : æµ‹è¯•è¯·æ±‚
Target-->>Validator : å“åº”
Validator-->>Pool : éªŒè¯ç»“æœ
Pool->>Manager : æ·»åŠ åˆ°è¿æ¥æ± 
Pool-->>Client : è¿”å›æ–°è¿æ¥
end
Client->>Pool : PutConnection(conn)
Pool->>Manager : æ ‡è®°è¿æ¥å¯ç”¨
```

**å›¾è¡¨æ¥æº**
- [utlsclient/utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L351-L395)
- [utlsclient/connection_manager.go](file://utlsclient/connection_manager.go#L76-L90)

### å…³é”®ç‰¹æ€§

1. **åŒé‡æ£€æŸ¥æ¨¡å¼**: é¿å…æ­»é”çš„å¹¶å‘å®‰å…¨æœºåˆ¶
2. **è¿æ¥å¥åº·æ£€æŸ¥**: å®šæœŸéªŒè¯è¿æ¥å¯ç”¨æ€§
3. **è‡ªåŠ¨é‡è¯•æœºåˆ¶**: è¿æ¥å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
4. **ç»Ÿè®¡ç›‘æ§**: å®æ—¶è·Ÿè¸ªè¿æ¥æ± çŠ¶æ€

**ç« èŠ‚æ¥æº**
- [utlsclient/utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L351-L800)

## TLSæŒ‡çº¹ä¼ªè£…æŠ€æœ¯

### æŠ€æœ¯åŸç†

TLS æŒ‡çº¹ä¼ªè£…æ˜¯é€šè¿‡æ¨¡æ‹ŸçœŸå®æµè§ˆå™¨çš„ TLS æ¡æ‰‹è¿‡ç¨‹æ¥éšè—çˆ¬è™«èº«ä»½ã€‚ç³»ç»Ÿæ”¯æŒ 33 ç§ä¸åŒçš„æµè§ˆå™¨æŒ‡çº¹ï¼Œæ¶µç›–ä¸»æµæµè§ˆå™¨çš„å„ç§ç‰ˆæœ¬ã€‚

### æŒ‡çº¹åº“æ¶æ„

```mermaid
classDiagram
class Library {
+profiles : []Profile
+rand : *rand.Rand
+mu : sync.Mutex
+All() []Profile
+RandomProfile() Profile
+ProfileByName(name) Profile
+ProfilesByBrowser(browser) []Profile
+ProfilesByPlatform(platform) []Profile
+RecommendedProfiles() []Profile
+RandomAcceptLanguage() string
}
class Profile {
+Name : string
+HelloID : utls.ClientHelloID
+UserAgent : string
+Description : string
+Platform : string
+Browser : string
+Version : string
}
Library --> Profile
```

**å›¾è¡¨æ¥æº**
- [utlsclient/utlsfingerprint.go](file://utlsclient/utlsfingerprint.go#L13-L29)

### æ”¯æŒçš„æµè§ˆå™¨æŒ‡çº¹

| æµè§ˆå™¨ç³»åˆ— | ç‰ˆæœ¬æ•°é‡ | æ”¯æŒå¹³å° | æè¿° |
|------------|----------|----------|------|
| Chrome | 12ç§ | Windows, macOS, Linux | ä¸»æµæ¡Œé¢æµè§ˆå™¨ï¼Œæ”¯æŒæœ€æ–°ç‰ˆæœ¬ |
| Firefox | 9ç§ | Windows, macOS | å¼€æºæµè§ˆå™¨ï¼Œæ”¯æŒç¨³å®šç‰ˆæœ¬ |
| Safari | 4ç§ | macOS, iOS | è‹¹æœç”Ÿæ€ç³»ç»Ÿæµè§ˆå™¨ |
| Edge | 3ç§ | Windows | å¾®è½¯æµè§ˆå™¨ï¼ŒåŸºäº Chromium |
| Randomized | 3ç§ | Random | éšæœºåŒ–æŒ‡çº¹ï¼Œå¢å¼ºéšè”½æ€§ |

### Accept-Language éšæœºåŒ–

ç³»ç»Ÿä» 90 ç§è¯­è¨€ä¸­éšæœºç»„åˆ 2-5 ç§è¯­è¨€ï¼Œç”Ÿæˆç‹¬ç‰¹çš„ Accept-Language å¤´ï¼š

```mermaid
flowchart TD
Start(["å¼€å§‹ç”Ÿæˆ"]) --> SelectCount["éšæœºé€‰æ‹©è¯­è¨€æ•°é‡<br/>2-5ç§"]
SelectCount --> GenLang["ç”Ÿæˆéšæœºè¯­è¨€åˆ—è¡¨"]
GenLang --> CheckUnique{"è¯­è¨€å”¯ä¸€æ€§æ£€æŸ¥"}
CheckUnique --> |é‡å¤| GenLang
CheckUnique --> |å”¯ä¸€| AddQuality["æ·»åŠ æƒé‡(Qå€¼)"]
AddQuality --> Format["æ ¼å¼åŒ–è¾“å‡º"]
Format --> End(["å®Œæˆ"])
```

**å›¾è¡¨æ¥æº**
- [utlsclient/utlsfingerprint.go](file://utlsclient/utlsfingerprint.go#L589-L630)

### æ€§èƒ½æŒ‡æ ‡

- **æŒ‡çº¹å¤šæ ·æ€§**: 33 ç§ä¸åŒæµè§ˆå™¨æŒ‡çº¹å‡åŒ€åˆ†å¸ƒ
- **è¯­è¨€ç‹¬ç‰¹æ€§**: 97.8% çš„ Accept-Language ç»„åˆå…·æœ‰ç‹¬ç‰¹æ€§
- **éšæœºåŒ–æ•ˆæœ**: æ¯æ¬¡å»ºç«‹è¿æ¥æ—¶éšæœºé€‰æ‹©æŒ‡çº¹ï¼Œæ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸º

**ç« èŠ‚æ¥æº**
- [utlsclient/utlsfingerprint.go](file://utlsclient/utlsfingerprint.go#L112-L631)

## IPæ± ç®¡ç†æœºåˆ¶

### åŒå±‚IPæ± æ¶æ„

ç³»ç»Ÿé‡‡ç”¨åŒå±‚ IP æ± æ¶æ„ï¼Œç»“åˆæœ¬åœ° IP æ± å’Œè¿œç¨‹åŸŸå IP æ± ï¼Œæä¾›çµæ´»çš„ IP ç®¡ç†ç­–ç•¥ã€‚

```mermaid
graph TB
subgraph "IPæ± ç®¡ç†å±‚"
IPM[IPæ± ç®¡ç†å™¨]
WBC[ç™½åå•/é»‘åå•æ§åˆ¶å™¨]
end
subgraph "æœ¬åœ°IPæ± "
LIP[LocalIPPool]
StaticIPv4[é™æ€IPv4æ± ]
DynamicIPv6[åŠ¨æ€IPv6æ± ]
end
subgraph "è¿œç¨‹IPæ± "
RIP[RemoteDomainIPPool]
Monitor[åŸŸåç›‘æ§å™¨]
DNSResolver[DNSè§£æå™¨]
IPInfo[IPä¿¡æ¯æŸ¥è¯¢]
end
IPM --> LIP
IPM --> RIP
IPM --> WBC
LIP --> StaticIPv4
LIP --> DynamicIPv6
RIP --> Monitor
Monitor --> DNSResolver
Monitor --> IPInfo
```

**å›¾è¡¨æ¥æº**
- [localippool/localippool.go](file://localippool/localippool.go#L32-L69)
- [remotedomainippool/remotedomainippool.go](file://remotedomainippool/remotedomainippool.go#L101-L109)

### æœ¬åœ°IPæ± åŠŸèƒ½

æœ¬åœ° IP æ± å…·å¤‡æ™ºèƒ½è‡ªé€‚åº”èƒ½åŠ›ï¼Œèƒ½å¤Ÿæ ¹æ®ç³»ç»Ÿç¯å¢ƒè‡ªåŠ¨è°ƒæ•´ï¼š

1. **IPv4æ”¯æŒ**: ä½¿ç”¨é™æ€é…ç½®çš„ IPv4 åœ°å€
2. **IPv6åŠ¨æ€ç”Ÿæˆ**: åœ¨æ”¯æŒçš„ç¯å¢ƒä¸­åŠ¨æ€ç”Ÿæˆ IPv6 åœ°å€
3. **ç¯å¢ƒæ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿç½‘ç»œé…ç½®
4. **æ‰¹é‡ç®¡ç†**: æ”¯æŒæ‰¹é‡åˆ›å»ºå’Œæ¸…ç† IP åœ°å€

### è¿œç¨‹åŸŸåIPæ± 

è¿œç¨‹åŸŸå IP æ± é€šè¿‡å®æ—¶ç›‘æ§åŸŸåå˜åŒ–æ¥ç»´æŠ¤æœ€æ–°çš„ IP åœ°å€æ± ï¼š

```mermaid
sequenceDiagram
participant Monitor as åŸŸåç›‘æ§å™¨
participant DNS as DNSè§£æå™¨
participant API as IPä¿¡æ¯API
participant Storage as å­˜å‚¨ç³»ç»Ÿ
loop å®šæœŸæ›´æ–°
Monitor->>DNS : å¹¶å‘DNSæŸ¥è¯¢
DNS-->>Monitor : è¿”å›IPåˆ—è¡¨
Monitor->>Monitor : å»é‡å’Œè¿‡æ»¤
Monitor->>API : æŸ¥è¯¢IPè¯¦ç»†ä¿¡æ¯
API-->>Monitor : è¿”å›IPä¿¡æ¯
Monitor->>Storage : ä¿å­˜åˆ°æ–‡ä»¶
Storage-->>Monitor : ç¡®è®¤ä¿å­˜
end
```

**å›¾è¡¨æ¥æº**
- [remotedomainippool/remotedomainippool.go](file://remotedomainippool/remotedomainippool.go#L286-L355)

### IPè®¿é—®æ§åˆ¶

ç³»ç»Ÿæä¾›å®Œå–„çš„ç™½åå•å’Œé»‘åå•æœºåˆ¶ï¼š

- **ç™½åå•**: è®°å½•ç»è¿‡éªŒè¯çš„å¯ç”¨ IP
- **é»‘åå•**: è¿‡æ»¤æ‰è¢«å°ç¦æˆ–ä¸å¯ç”¨çš„ IP
- **åŠ¨æ€æ›´æ–°**: æ ¹æ®è¿æ¥æˆåŠŸç‡è‡ªåŠ¨è°ƒæ•´é»‘ç™½åå•

**ç« èŠ‚æ¥æº**
- [localippool/localippool.go](file://localippool/localippool.go#L1-L800)
- [remotedomainippool/remotedomainippool.go](file://remotedomainippool/remotedomainippool.go#L1-L472)

## HTTPåè®®æ”¯æŒ

### åŒåè®®è‡ªåŠ¨æ£€æµ‹

ç³»ç»Ÿèƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹å’Œåå•† HTTP/1.1 å’Œ HTTP/2 åè®®ï¼š

```mermaid
flowchart TD
Start([å»ºç«‹è¿æ¥]) --> Handshake[TLSæ¡æ‰‹]
Handshake --> Detect[æ£€æµ‹åå•†åè®®]
Detect --> HTTP2{åè®®æ˜¯HTTP/2?}
HTTP2 --> |æ˜¯| HTTP2Client[ä½¿ç”¨HTTP/2å®¢æˆ·ç«¯]
HTTP2 --> |å¦| HTTP1Client[ä½¿ç”¨HTTP/1.1å®¢æˆ·ç«¯]
HTTP2Client --> SendRequest[å‘é€HTTP/2è¯·æ±‚]
HTTP1Client --> BuildRequest[æ„å»ºåŸå§‹HTTPè¯·æ±‚]
BuildRequest --> SendRequest
SendRequest --> ReceiveResponse[æ¥æ”¶å“åº”]
ReceiveResponse --> End([å®Œæˆ])
```

**å›¾è¡¨æ¥æº**
- [utlsclient/utlsclient.go](file://utlsclient/utlsclient.go#L130-L141)

### HTTP/2 æ”¯æŒç‰¹æ€§

1. **è¿æ¥å¤ç”¨**: å•ä¸ª TCP è¿æ¥æ”¯æŒå¤šè·¯å¤ç”¨
2. **æœåŠ¡å™¨æ¨é€**: æ”¯æŒ HTTP/2 æœåŠ¡å™¨æ¨é€
3. **å¤´éƒ¨å‹ç¼©**: HPACK å‹ç¼©å‡å°‘ä¼ è¾“å¼€é”€
4. **æµä¼˜å…ˆçº§**: æ”¯æŒæµä¼˜å…ˆçº§æ§åˆ¶

### HTTP/1.1 å®ç°

å¯¹äº HTTP/1.1 åè®®ï¼Œç³»ç»Ÿå®ç°äº†å®Œæ•´çš„åŸå§‹è¯·æ±‚æ„å»ºå’Œå“åº”è§£æï¼š

```mermaid
classDiagram
class UTLSClient {
+conn : *UTLSConnection
+timeout : time.Duration
+userAgent : string
+maxRetries : int
+Do(req) *http.Response
+doHTTP1Request(req) *http.Response
+buildRawRequest(req) string
+readResponse(reader) *http.Response
}
class responseBody {
+reader : *bufio.Reader
+conn : *utls.UConn
+closed : bool
+mu : sync.Mutex
+Read(p) int
+Close() error
}
UTLSClient --> responseBody
```

**å›¾è¡¨æ¥æº**
- [utlsclient/utlsclient.go](file://utlsclient/utlsclient.go#L37-L52)
- [utlsclient/utlsclient.go](file://utlsclient/utlsclient.go#L333-L363)

### IPv6 å®Œæ•´æ”¯æŒ

ç³»ç»Ÿå®Œå…¨æ”¯æŒ IPv6 åœ°å€è¿æ¥ï¼ŒåŒ…æ‹¬ï¼š

- **åœ°å€æ ¼å¼å¤„ç†**: è‡ªåŠ¨è¯†åˆ«å’Œå¤„ç† IPv6 åœ°å€æ ¼å¼
- **æ–¹æ‹¬å·åŒ…è£¹**: æ­£ç¡®å¤„ç† IPv6 åœ°å€çš„æ–¹æ‹¬å·æ ¼å¼
- **åŒæ ˆç½‘ç»œ**: åŒæ—¶æ”¯æŒ IPv4 å’Œ IPv6
- **éš§é“æ¨¡å¼**: æ”¯æŒé€šè¿‡ IPv6 éš§é“è¿æ¥

**ç« èŠ‚æ¥æº**
- [utlsclient/utlsclient.go](file://utlsclient/utlsclient.go#L1-L392)

## Google Earth Q2è§£æå™¨

### è®¾è®¡ç›®çš„

Google Earth Q2 è§£æå™¨æ—¨åœ¨è§£æ Google Earth çš„ Q2 æ•°æ®åŒ…ï¼Œæå–å…¶ä¸­çš„å½±åƒã€åœ°å½¢ã€çŸ¢é‡å’Œå­èŠ‚ç‚¹å¼•ç”¨ä¿¡æ¯ã€‚è¯¥åŠŸèƒ½æ”¯æŒå°†äºŒè¿›åˆ¶ Q2 æ•°æ®è½¬æ¢ä¸ºç»“æ„åŒ–çš„ JSON æ ¼å¼ï¼Œä¾¿äºåç»­å¤„ç†å’Œåˆ†æã€‚

### å®ç°ç»†èŠ‚

Q2 è§£æå™¨é‡‡ç”¨æ¥å£é©±åŠ¨è®¾è®¡ï¼Œæä¾›çµæ´»çš„æ‰©å±•èƒ½åŠ›ï¼š

```mermaid
classDiagram
class Q2Parser {
<<interface>>
+Parse(body []byte, tilekey string, rootNode bool, baseURL string) (*Q2Response, error)
+ParseToJSON(body []byte, tilekey string, rootNode bool, baseURL string) (string, error)
}
class DefaultQ2Parser {
+Parse(body []byte, tilekey string, rootNode bool, baseURL string) (*Q2Response, error)
+ParseToJSON(body []byte, tilekey string, rootNode bool, baseURL string) (string, error)
}
class Q2URLBuilder {
<<interface>>
+Imagery(tilekey string, version uint16) string
+Terrain(tilekey string, version uint16) string
+Q2(tilekey string, version uint16) string
}
class PathOnlyURLBuilder {
+Base string
+Imagery(tilekey string, version uint16) string
+Terrain(tilekey string, version uint16) string
+Q2(tilekey string, version uint16) string
}
class Q2Filter {
<<interface>>
+IncludeImagery(tilekey string, version uint16, provider uint16) bool
+IncludeTerrain(tilekey string, version uint16, provider uint16) bool
+IncludeQ2(tilekey string, version uint16) bool
}
class DefaultQ2Filter {
+IncludeImagery(tilekey string, version uint16, provider uint16) bool
+IncludeTerrain(tilekey string, version uint16, provider uint16) bool
+IncludeQ2(tilekey string, version uint16) bool
}
Q2Parser <|.. DefaultQ2Parser
Q2URLBuilder <|.. PathOnlyURLBuilder
Q2Filter <|.. DefaultQ2Filter
```

**å›¾è¡¨æ¥æº**
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go#L8-L13)
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go#L40-L45)
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go#L73-L78)

### æ ¸å¿ƒåŠŸèƒ½

1. **äºŒè¿›åˆ¶è§£æ**: ä½¿ç”¨ `QuadTreePacket16` è§£ç  Q2 äºŒè¿›åˆ¶æ ¼å¼
2. **JSONè½¬æ¢**: å°†è§£æç»“æœè½¬æ¢ä¸ºç»“æ„åŒ–çš„ JSON æ ¼å¼
3. **URLæ„é€ **: æ”¯æŒæ ¹æ®åŸºç¡€ URL æ„é€ å®Œæ•´çš„è¯·æ±‚ URL
4. **æ•°æ®è¿‡æ»¤**: æä¾›è¿‡æ»¤ç­–ç•¥ï¼Œæ§åˆ¶è¾“å‡ºçš„æ•°æ®ç±»å‹
5. **é€‰é¡¹æ”¯æŒ**: æ”¯æŒé€šè¿‡ `Q2ParseOptions` æ§åˆ¶è¾“å‡ºå†…å®¹

### ä½¿ç”¨ç¤ºä¾‹

```go
// åˆ›å»º Q2 è§£æå™¨
parser := GoogleEarth.NewQ2Parser()

// è§£æ Q2 æ•°æ®
body := []byte{...} // ä»ç½‘ç»œè·å–çš„ Q2 æ•°æ®
jsonStr, err := parser.ParseToJSON(body, "0", true, "https://kh.google.com")
if err != nil {
    log.Fatal(err)
}

// è§£æä¸ºç»“æ„ä½“
response, err := parser.Parse(body, "0", true, "https://kh.google.com")
if err != nil {
    log.Fatal(err)
}

// ä½¿ç”¨é€‰é¡¹æ§åˆ¶è¾“å‡º
opts := GoogleEarth.Q2ParseOptions{
    IncludeImagery: true,
    IncludeTerrain: false,
    IncludeVector:  true,
    IncludeQ2:      true,
}
jsonStr, err = GoogleEarth.ParseQ2BodyWithOptions(body, "0", true, "https://kh.google.com", opts)
```

**ç« èŠ‚æ¥æº**
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go#L150-L480)

## å¤šåç«¯å­˜å‚¨æ¶æ„

### è®¾è®¡ç›®çš„

å¤šåç«¯å­˜å‚¨æ¶æ„æ—¨åœ¨æä¾›çµæ´»ã€é«˜æ€§èƒ½çš„ç“¦ç‰‡æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚ç³»ç»Ÿæ”¯æŒå¤šç§æŒä¹…åŒ–åç«¯å’Œç¼“å­˜ç­–ç•¥ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯ä¸‹çš„æ€§èƒ½å’Œå¯é æ€§éœ€æ±‚ã€‚

### å®ç°ç»†èŠ‚

å­˜å‚¨æ¶æ„é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œæ”¯æŒå¤šç§æŒä¹…åŒ–åç«¯å’Œç¼“å­˜ç­–ç•¥ï¼š

```mermaid
classDiagram
class TileStorage {
+config : TileStorageConfig
+persistQueue : chan *persistTask
+persistWg : sync.WaitGroup
+ctx : context.Context
+cancel : context.CancelFunc
+Put(dataType, tilekey, value) error
+PutBatch(dataType, records) error
+Get(dataType, tilekey) ([]byte, error)
+Delete(dataType, tilekey) error
+Exists(dataType, tilekey) (bool, error)
+InvalidateCache(dataType, tilekey) error
+WarmupCache(dataType, tilekeys) error
+Close() error
+GetBackend() StorageBackend
+IsCacheEnabled() bool
+IsAsyncPersistEnabled() bool
+GetPendingPersistCount() int
}
class TileStorageConfig {
+Backend : StorageBackend
+DBDir : string
+RedisAddr : string
+CacheExpiration : time.Duration
+EnableCache : bool
+EnableAsyncPersist : bool
+PersistBatchSize : int
+PersistInterval : time.Duration
+ClearRedisAfterPersist : *bool
}
class StorageBackend {
<<enumeration>>
+BackendBBolt
+BackendSQLite
}
class persistTask {
+dataType : string
+tilekey : string
+value : []byte
}
TileStorage --> TileStorageConfig
TileStorage --> persistTask
```

**å›¾è¡¨æ¥æº**
- [Store/tilestorage.go](file://Store/tilestorage.go#L19-L39)
- [Store/tilestorage.go](file://Store/tilestorage.go#L43-L51)

### æ ¸å¿ƒåŠŸèƒ½

1. **å¤šåç«¯æ”¯æŒ**: æ”¯æŒ BBolt å’Œ SQLite ä¸¤ç§æŒä¹…åŒ–åç«¯
2. **Redisç¼“å­˜**: å¯é€‰ Redis ä½œä¸ºè¯»ç¼“å­˜ï¼Œæå‡è¯»å–æ€§èƒ½
3. **å¼‚æ­¥æŒä¹…åŒ–**: æ”¯æŒå…ˆå†™ Redis ç¼“å†²ï¼Œåå°å¼‚æ­¥åˆ·ç›˜
4. **åˆ†å±‚å­˜å‚¨**: æ ¹æ®ç“¦ç‰‡å±‚çº§è‡ªåŠ¨é€‰æ‹©å­˜å‚¨ç­–ç•¥
5. **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡è¯»å†™ï¼Œæå‡æ€§èƒ½
6. **ç¼“å­˜é¢„çƒ­**: æ”¯æŒé¢„çƒ­ç¼“å­˜ï¼Œæå‡åˆå§‹æ€§èƒ½

### é…ç½®é€‰é¡¹

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| `Backend` | æŒä¹…åŒ–åç«¯ç±»å‹ï¼ˆ`bbolt` æˆ– `sqlite`ï¼‰ |
| `DBDir` | æŒä¹…åŒ–æ•°æ®åº“æ ¹ç›®å½• |
| `RedisAddr` | Redis åœ°å€ï¼Œå¯ç”¨ç¼“å­˜æˆ–å¼‚æ­¥æ¨¡å¼æ—¶å¿…éœ€ |
| `CacheExpiration` | Redis ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆ0 = æ°¸ä¸è¿‡æœŸï¼‰ |
| `EnableCache` | æ˜¯å¦å¯ç”¨ Redis ç¼“å­˜ |
| `EnableAsyncPersist` | æ˜¯å¦å¯ç”¨å¼‚æ­¥æŒä¹…åŒ–ï¼ˆRedis ä½œä¸ºå†™ç¼“å†²åŒºï¼‰ |
| `PersistBatchSize` | å¼‚æ­¥æŒä¹…åŒ–æ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤ 100ï¼‰ |
| `PersistInterval` | å¼‚æ­¥æŒä¹…åŒ–åˆ·æ–°é—´éš”ï¼ˆé»˜è®¤ 5 ç§’ï¼‰ |
| `ClearRedisAfterPersist` | æŒä¹…åŒ–æˆåŠŸåæ˜¯å¦æ¸…ç† Redisï¼ˆé»˜è®¤ trueï¼‰ |

### ä½¿ç”¨ç¤ºä¾‹

```go
// é…ç½®å­˜å‚¨
config := Store.TileStorageConfig{
    Backend:         Store.BackendBBolt,
    DBDir:           "/data/tiles",
    RedisAddr:       "localhost:6379",
    CacheExpiration: 1 * time.Hour,
    EnableCache:     true,
    EnableAsyncPersist: true,
    PersistBatchSize: 100,
    PersistInterval:  10 * time.Second,
}

// åˆ›å»ºå­˜å‚¨ç®¡ç†å™¨
storage, err := Store.NewTileStorage(config)
if err != nil {
    log.Fatal(err)
}
defer storage.Close()

// å†™å…¥ç“¦ç‰‡
err = storage.Put("imagery", "01230123", []byte("tile_data"))
if err != nil {
    log.Fatal(err)
}

// è¯»å–ç“¦ç‰‡
data, err := storage.Get("imagery", "01230123")
if err != nil {
    log.Fatal(err)
}
```

**ç« èŠ‚æ¥æº**
- [Store/tilestorage.go](file://Store/tilestorage.go#L61-L454)
- [Store/bblotdb.go](file://Store/bblotdb.go)
- [Store/sqlitedb.go](file://Store/sqlitedb.go)
- [Store/dbpath.go](file://Store/dbpath.go)

## åŠŸèƒ½ä¾èµ–å…³ç³»åˆ†æ

### æ ¸å¿ƒä¾èµ–é“¾

```mermaid
graph TD
UTLSHotConnPool[çƒ­è¿æ¥æ± ] --> ConnectionManager[è¿æ¥ç®¡ç†å™¨]
UTLSHotConnPool --> HealthChecker[å¥åº·æ£€æŸ¥å™¨]
UTLSHotConnPool --> ConnectionValidator[è¿æ¥éªŒè¯å™¨]
UTLSHotConnPool --> IPAccessController[IPè®¿é—®æ§åˆ¶å™¨]
ConnectionManager --> UTLSConnection[UTLSè¿æ¥]
HealthChecker --> ConnectionManager
ConnectionValidator --> UTLSConnection
UTLSHotConnPool --> Library[TLSæŒ‡çº¹åº“]
UTLSHotConnPool --> IPPoolProvider[IPæ± æä¾›è€…]
UTLSClient[UTLSå®¢æˆ·ç«¯] --> UTLSConnection
UTLSClient --> HTTP2Transport[HTTP/2ä¼ è¾“]
UTLSClient --> HTTP1Transport[HTTP/1.1ä¼ è¾“]
IPPoolProvider --> LocalIPPool[æœ¬åœ°IPæ± ]
IPPoolProvider --> RemoteIPPool[è¿œç¨‹IPæ± ]
UTLSHotConnPool --> Q2Parser[Q2è§£æå™¨]
UTLSHotConnPool --> TileStorage[å­˜å‚¨ç®¡ç†å™¨]
TileStorage --> BBolt[BBoltæŒä¹…åŒ–]
TileStorage --> SQLite[SQLiteæŒä¹…åŒ–]
TileStorage --> Redis[Redisç¼“å­˜]
```

**å›¾è¡¨æ¥æº**
- [utlsclient/utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L236-L258)
- [utlsclient/connection_manager.go](file://utlsclient/connection_manager.go#L8-L14)
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go#L19-L24)
- [Store/tilestorage.go](file://Store/tilestorage.go#L43-L45)

### äº¤äº’æµç¨‹

1. **çƒ­è¿æ¥æ± ** ä¾èµ– **TLSæŒ‡çº¹åº“** æä¾›æŒ‡çº¹é…ç½®
2. **çƒ­è¿æ¥æ± ** ä½¿ç”¨ **IPæ± ç®¡ç†å™¨** è·å–å¯ç”¨ IP åœ°å€
3. **è¿æ¥ç®¡ç†å™¨** ç®¡ç† **UTLSè¿æ¥** çš„ç”Ÿå‘½å‘¨æœŸ
4. **å¥åº·æ£€æŸ¥å™¨** å®šæœŸéªŒè¯è¿æ¥çŠ¶æ€
5. **UTLSå®¢æˆ·ç«¯** ä½¿ç”¨ **HTTP/1.1/HTTP/2ä¼ è¾“** å‘é€è¯·æ±‚
6. **çƒ­è¿æ¥æ± ** ä½¿ç”¨ **Q2è§£æå™¨** è§£æ Google Earth Q2 æ•°æ®
7. **çƒ­è¿æ¥æ± ** ä½¿ç”¨ **å­˜å‚¨ç®¡ç†å™¨** å­˜å‚¨å’Œè¯»å–ç“¦ç‰‡æ•°æ®
8. **å­˜å‚¨ç®¡ç†å™¨** ä½¿ç”¨ **BBolt/SQLite** è¿›è¡ŒæŒä¹…åŒ–ï¼Œå¯é€‰ **Redis** ä½œä¸ºç¼“å­˜

### æ•°æ®æµå‘

```mermaid
flowchart LR
Config[é…ç½®æ–‡ä»¶] --> Pool[çƒ­è¿æ¥æ± ]
FingerprintLib[TLSæŒ‡çº¹åº“] --> Pool
IPPool[IPæ± ] --> Pool
Pool --> ConnMgr[è¿æ¥ç®¡ç†å™¨]
ConnMgr --> HealthCheck[å¥åº·æ£€æŸ¥]
ConnMgr --> Validator[è¿æ¥éªŒè¯]
Pool --> Client[UTLSå®¢æˆ·ç«¯]
Client --> HTTP1[HTTP/1.1å¤„ç†]
Client --> HTTP2[HTTP/2å¤„ç†]
Pool --> Q2Parser[Q2è§£æå™¨]
Pool --> Storage[å­˜å‚¨ç®¡ç†å™¨]
Storage --> BBolt[BBoltæŒä¹…åŒ–]
Storage --> SQLite[SQLiteæŒä¹…åŒ–]
Storage --> Redis[Redisç¼“å­˜]
```

**ç« èŠ‚æ¥æº**
- [utlsclient/utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L291-L350)
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go#L150-L480)
- [Store/tilestorage.go](file://Store/tilestorage.go#L61-L454)

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### è¿æ¥æ± ä¼˜åŒ–

1. **åˆç†é…ç½®è¿æ¥æ•°**
   - `MaxConnections`: æ ¹æ®å¹¶å‘éœ€æ±‚è®¾ç½®
   - `MaxConnsPerHost`: æ§åˆ¶å•ä¸»æœºè¿æ¥æ•°
   - `MaxIdleConns`: ä¿æŒé€‚é‡ç©ºé—²è¿æ¥

2. **è¶…æ—¶å‚æ•°è°ƒä¼˜**
   - `ConnTimeout`: è¿æ¥å»ºç«‹è¶…æ—¶æ—¶é—´
   - `IdleTimeout`: ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´
   - `MaxLifetime`: è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ

3. **å¥åº·æ£€æŸ¥ä¼˜åŒ–**
   - `HealthCheckInterval`: å¥åº·æ£€æŸ¥é—´éš”
   - `TestTimeout`: æµ‹è¯•è¯·æ±‚è¶…æ—¶æ—¶é—´

### IPæ± ä¼˜åŒ–

1. **æœ¬åœ°IPæ± **
   - åˆç†é…ç½®é™æ€IPv4åœ°å€
   - æ ¹æ®ç½‘ç»œç¯å¢ƒè°ƒæ•´IPv6æ”¯æŒ

2. **è¿œç¨‹IPæ± **
   - è®¾ç½®åˆé€‚çš„æ›´æ–°é—´éš”
   - ä¼˜åŒ–DNSæŸ¥è¯¢å¹¶å‘æ•°

### TLSæŒ‡çº¹ä¼˜åŒ–

1. **æŒ‡çº¹é€‰æ‹©ç­–ç•¥**
   - æ ¹æ®ç›®æ ‡ç½‘ç«™ç‰¹å¾é€‰æ‹©åˆé€‚æŒ‡çº¹
   - å®šæœŸè½®æ¢æŒ‡çº¹ç±»å‹

2. **è¯­è¨€éšæœºåŒ–**
   - æ ¹æ®ç›®æ ‡åœ°åŒºè°ƒæ•´è¯­è¨€ç»„åˆ
   - å¹³è¡¡éšæœºæ€§å’Œç‹¬ç‰¹æ€§

### Q2è§£æå™¨ä¼˜åŒ–

1. **ç¼“å­˜ç­–ç•¥**
   - å¯¹é¢‘ç¹è®¿é—®çš„ Q2 æ•°æ®ä½¿ç”¨ Redis ç¼“å­˜
   - è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´

2. **æ‰¹é‡å¤„ç†**
   - æ‰¹é‡è§£æå¤šä¸ª Q2 æ•°æ®åŒ…
   - ä½¿ç”¨å¹¶å‘å¤„ç†æå‡æ€§èƒ½

3. **å†…å­˜ä¼˜åŒ–**
   - åŠæ—¶é‡Šæ”¾ä¸å†éœ€è¦çš„è§£æç»“æœ
   - ä½¿ç”¨å¯¹è±¡æ± å‡å°‘å†…å­˜åˆ†é…

### å­˜å‚¨æ¶æ„ä¼˜åŒ–

1. **åç«¯é€‰æ‹©**
   - é«˜æ€§èƒ½åœºæ™¯é€‰æ‹© BBolt
   - è·¨å¹³å°åœºæ™¯é€‰æ‹© SQLite

2. **ç¼“å­˜é…ç½®**
   - é«˜é¢‘è¯»å–åœºæ™¯å¯ç”¨ Redis ç¼“å­˜
   - è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´

3. **å¼‚æ­¥æŒä¹…åŒ–**
   - é«˜é¢‘å†™å…¥åœºæ™¯å¯ç”¨å¼‚æ­¥æŒä¹…åŒ–
   - è°ƒæ•´æ‰¹æ¬¡å¤§å°å’Œåˆ·æ–°é—´éš”

**ç« èŠ‚æ¥æº**
- [utlsclient/utlshotconnpool.go](file://utlsclient/utlshotconnpool.go#L170-L202)
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go#L150-L480)
- [Store/tilestorage.go](file://Store/tilestorage.go#L61-L454)

## æœ€ä½³å®è·µæŒ‡å—

### ä½¿ç”¨çƒ­è¿æ¥æ± 

```mermaid
sequenceDiagram
participant App as åº”ç”¨ç¨‹åº
participant Pool as çƒ­è¿æ¥æ± 
participant Client as UTLSå®¢æˆ·ç«¯
App->>Pool : NewUTLSHotConnPool(config)
App->>Pool : GetConnection(host)
Pool-->>App : è¿”å›è¿æ¥
App->>Client : NewUTLSClient(conn)
App->>Client : å‘é€HTTPè¯·æ±‚
Client-->>App : è¿”å›å“åº”
App->>Pool : PutConnection(conn)
App->>Pool : Close()
```

**å›¾è¡¨æ¥æº**
- [examples/utlsclient/example_hotconnpool_usage.go](file://examples/utlsclient/example_hotconnpool_usage.go#L46-L116)

### æ¨èä½¿ç”¨æ¨¡å¼

1. **é¢„çƒ­è¿æ¥**: åœ¨å¼€å§‹å¤§è§„æ¨¡è¯·æ±‚å‰é¢„çƒ­è¿æ¥æ± 
2. **è½®è¯¢ä½¿ç”¨**: é‡‡ç”¨ã€è·å–-ä½¿ç”¨-å½’è¿˜ã€‘æ¨¡å¼
3. **å¹¶å‘æ§åˆ¶**: åˆç†æ§åˆ¶å¹¶å‘æ•°å’Œè¯·æ±‚é¢‘ç‡
4. **é”™è¯¯å¤„ç†**: å®ç°å®Œå–„çš„é”™è¯¯é‡è¯•æœºåˆ¶

### é…ç½®å»ºè®®

1. **è¿æ¥æ± é…ç½®**
   ```go
   config := &PoolConfig{
       MaxConnections:         100,
       MaxConnsPerHost:        10,
       ConnTimeout:            30 * time.Second,
       IdleTimeout:            60 * time.Second,
       MaxLifetime:            300 * time.Second,
   }
   ```

2. **è¶…æ—¶è®¾ç½®**
   ```go
   client.SetTimeout(15 * time.Second)
   ```

3. **é”™è¯¯é‡è¯•**
   ```go
   client.SetMaxRetries(3)
   ```

4. **Q2è§£æå™¨é…ç½®**
   ```go
   opts := GoogleEarth.Q2ParseOptions{
       IncludeImagery: true,
       IncludeTerrain: true,
       IncludeVector:  true,
       IncludeQ2:      true,
   }
   ```

5. **å­˜å‚¨æ¶æ„é…ç½®**
   ```go
   config := Store.TileStorageConfig{
       Backend:         Store.BackendBBolt,
       DBDir:           "/data/tiles",
       RedisAddr:       "localhost:6379",
       CacheExpiration: 1 * time.Hour,
       EnableCache:     true,
       EnableAsyncPersist: true,
       PersistBatchSize: 100,
       PersistInterval:  10 * time.Second,
   }
   ```

**ç« èŠ‚æ¥æº**
- [examples/utlsclient/example_hotconnpool_usage.go](file://examples/utlsclient/example_hotconnpool_usage.go#L1-L277)
- [examples/utlsclient/example_utlsclient_usage.go](file://examples/utlsclient/example_utlsclient_usage.go#L1-L117)
- [GoogleEarth/geq2.go](file://GoogleEarth/geq2.go#L150-L480)
- [Store/tilestorage.go](file://Store/tilestorage.go#L61-L454)

## æ€»ç»“

Crawler Platform é€šè¿‡åˆ›æ–°çš„æŠ€æœ¯ç»„åˆï¼Œå®ç°äº†é«˜æ€§èƒ½å’Œé«˜éšè”½æ€§çš„çˆ¬è™«è§£å†³æ–¹æ¡ˆï¼š

### æ ¸å¿ƒä¼˜åŠ¿

1. **æ€§èƒ½å“è¶Š**: çƒ­è¿æ¥æ± æŠ€æœ¯å®ç° 3-6 å€æ€§èƒ½æå‡
2. **éšè”½æ€§å¼º**: TLS æŒ‡çº¹ä¼ªè£…å’Œå¤šè¯­è¨€éšæœºåŒ–
3. **ç¨³å®šæ€§é«˜**: å®Œå–„çš„å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡è¯•æœºåˆ¶
4. **æ‰©å±•æ€§å¥½**: æ¨¡å—åŒ–è®¾è®¡æ”¯æŒçµæ´»é…ç½®
5. **åŠŸèƒ½ä¸°å¯Œ**: æ–°å¢ Google Earth Q2 è§£æå™¨ï¼Œæ”¯æŒè§£æå¤æ‚åœ°ç†æ•°æ®
6. **å­˜å‚¨çµæ´»**: æ–°å¢å¤šåç«¯å­˜å‚¨æ¶æ„ï¼Œæ”¯æŒå¤šç§æŒä¹…åŒ–å’Œç¼“å­˜ç­–ç•¥

### æŠ€æœ¯åˆ›æ–°

- **æ™ºèƒ½è¿æ¥å¤ç”¨**: é¿å…é‡å¤ TLS æ¡æ‰‹å¼€é”€
- **åŠ¨æ€æŒ‡çº¹é€‰æ‹©**: æ ¹æ®ç›®æ ‡ç½‘ç«™ç‰¹å¾é€‰æ‹©æœ€ä¼˜æŒ‡çº¹
- **åŒæ ˆç½‘ç»œæ”¯æŒ**: åŒæ—¶æ”¯æŒ IPv4 å’Œ IPv6
- **å®æ—¶IPç›‘æ§**: è¿œç¨‹åŸŸåIPæ± åŠ¨æ€æ›´æ–°
- **Q2æ•°æ®è§£æ**: æ”¯æŒè§£æ Google Earth Q2 æ•°æ®åŒ…ï¼Œæå–åœ°ç†ä¿¡æ¯
- **å¤šåç«¯å­˜å‚¨**: æ”¯æŒ BBolt å’Œ SQLite æŒä¹…åŒ–ï¼Œå¯é€‰ Redis ç¼“å­˜å’Œå¼‚æ­¥æŒä¹…åŒ–

### åº”ç”¨åœºæ™¯

- **Webçˆ¬è™«**: é«˜æ•ˆæŠ“å–ç½‘é¡µå†…å®¹
- **APIæµ‹è¯•**: æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¯·æ±‚
- **å®‰å…¨ç ”ç©¶**: åˆ†æWebåº”ç”¨å®‰å…¨é˜²æŠ¤
- **æ•°æ®é‡‡é›†**: å¤§è§„æ¨¡æ•°æ®æ”¶é›†
- **åœ°ç†ä¿¡æ¯å¤„ç†**: è§£æå’Œå¤„ç† Google Earth åœ°ç†æ•°æ®
- **é«˜æ€§èƒ½å­˜å‚¨**: é«˜é¢‘è¯»å†™åœºæ™¯ä¸‹çš„æ•°æ®å­˜å‚¨

é€šè¿‡åˆç†é…ç½®å’Œä½¿ç”¨è¿™äº›æ ¸å¿ƒåŠŸèƒ½ï¼Œå¼€å‘è€…å¯ä»¥æ„å»ºå‡ºé«˜æ•ˆã€ç¨³å®šçš„çˆ¬è™«ç³»ç»Ÿï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„éšè”½æ€§å’Œæ‰©å±•æ€§ã€‚